# https://taskfile.dev

version: "3"

vars:
  LIBRARY_DIR: packages/findingmodelforge
  API_DIR: packages/fmf-api
  TMP_PACKAGES_DIR: tmp_packages
  API_CONTAINER_NAME: findingmodelforge-api:latest

tasks:
  test_library:
    desc: "Test the findingmodelforge library"
    dir: "{{.LIBRARY_DIR}}"
    cmds:
      # Check if the mongodb container is running; if not, have to use 'pytest -m "not needs_db"'
      - |
        if [ "$OS" = "Windows_NT" ]; then
          powershell.exe -Command "docker ps | Select-String -Pattern 'mongodb' -Quiet; if (\$?) { pytest } else { pytest -m 'not needs_db' }"
        else
          sh -c "docker ps | grep -q mongodb && pytest || pytest -m 'not needs_db'"
        fi
    silent: true

  test_library_with_db:
    desc: "Test the findingmodelforge library with a MongoDB instance"
    deps:
      - start_local_mongo
    dir: "{{.LIBRARY_DIR}}"
    cmds:
      - uv run pytest
    silent: true

  check_library:
    desc: "Check the findingmodelforge library"
    dir: "{{.LIBRARY_DIR}}"
    cmds:
      - echo "Checking library..."
      - uv run ruff format
      - uv run ruff check
      - uv run mypy src
      # Do the test_library task
      - task test_library
    silent: true

  build_library:
    desc: "Build the findingmodelforge library"
    dir: "{{.LIBRARY_DIR}}"
    cmds:
      - echo "Building library..."
      - uv build
      - echo "Building findingmodelforge-files image..."
      - docker build --platform linux/amd64 -t findingmodelforge-files:latest .
    silent: true

  build_api:
    desc: "Build the findingmodelforge API container"
    deps:
      - build_library
    dir: "{{.API_DIR}}"
    cmds:
      - echo "Building API image..."
      - docker build --platform linux/amd64 -t {{.API_CONTAINER_NAME}} .
    silent: true

  run_api:
    desc: "Run the findingmodelforge API container"
    dir: "{{.API_DIR}}"
    cmds:
      - docker run -p 8000:80 {{.API_CONTAINER_NAME}}
    silent: true

  start_local_mongo:
    desc: "Start a local MongoDB instance"
    cmds:
      # Check to see if the mongodb container is already running
      - |
        if [ "$OS" = "Windows_NT" ]; then
          powershell.exe -Command "docker ps | Select-String -Pattern 'mongodb' -Quiet; if (-not \$?) { docker run --name mongodb -p 27017:27017 -d mongo:latest }"
        else
          sh -c "docker ps | grep -q mongodb || docker run --name mongodb -p 27017:27017 -d mongo:latest"
        fi
    silent: true

  stop_local_mongo:
    desc: "Stop the local MongoDB instance"
    cmds:
      - |
        if [ "$OS" = "Windows_NT" ]; then
          powershell.exe -Command "docker stop mongodb"
        else
          sh -c "docker stop mongodb"
        fi
    silent: true
