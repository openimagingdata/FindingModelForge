# https://taskfile.dev

version: '3'

vars:
  LIBRARY_DIR: packages/findingmodelforge
  API_DIR: packages/fmf-api
  TMP_PACKAGES_DIR: tmp_packages
  API_CONTAINER_NAME: findingmodelforge-api:latest

tasks:
  test_library:
    desc: "Test the findingmodelforge library"
    dir: "{{.LIBRARY_DIR}}"
    cmds:
      - docker ps | grep -q mongodb && uv run pytest || uv run pytest -m "not needs_db"
    silent: true

  test_library_with_db:
    desc: "Test the findingmodelforge library with a MongoDB instance"
    deps:
      - start_local_mongo
    dir: "{{.LIBRARY_DIR}}"
    cmds:
      - uv run pytest
    silent: true

  check_library:
    desc: "Check the findingmodelforge library"
    dir: "{{.LIBRARY_DIR}}"
    cmds:
      - echo "Checking library..."
      - uv run ruff format
      - uv run ruff check
      - uv run mypy src
      # Do the test_library task
      - task test_library
    silent: true

  build_library:
    desc: "Build the findingmodelforge library"
    dir: "{{.LIBRARY_DIR}}"
    cmds:
      - echo "Building library..."
      - uv build
    silent: true

  copy_library_to_api:
    desc: "(INT) Copy findingmodelforge library packages to the API directory"
    deps:
      - build_library
    dir: "{{.API_DIR}}"
    cmds:
      - echo "Copying library to API..."
      - mkdir -p {{.TMP_PACKAGES_DIR}}
      - cp -r ../../{{.LIBRARY_DIR}} {{.TMP_PACKAGES_DIR}}
      - rm -rf {{.TMP_PACKAGES_DIR}}/.venv
    internal: true

  build_api:
    desc: "Build the findingmodelforge API container"
    deps:
      - copy_library_to_api 
    dir: "{{.API_DIR}}"
    cmds:
      - echo "Building API container..."
      - docker build -t {{.API_CONTAINER_NAME}} .
      - rm -rf {{.TMP_PACKAGES_DIR}}
    silent: true
  
  run_api:
    desc: "Run the findingmodelforge API container"
    dir: "{{.API_DIR}}"
    cmds:
      - echo "Running API..."
      - docker run -p 8000:80 {{.API_CONTAINER_NAME}}
    silent: true
  
  start_local_mongo:
    desc: "Start a local MongoDB instance"
    cmds:
      # If we have a mongodb container, but it's stopped, start it
      - docker ps -a | grep -q mongodb && docker start mongodb || docker run -d -v mongodb_data:/data -p 27017:27017 --name mongodb mongo
    silent: true
  
  stop_local_mongo:
    desc: "Stop the local MongoDB instance"
    cmds:
      - docker stop mongodb
    silent: true